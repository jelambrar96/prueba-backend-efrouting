name: Deploy Lambda Function

on:
  push:
    branches: [ main ]
    paths:
      - 'compute/lambda/**'
      - '.github/workflows/deploy-lambda.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - prod

env:
  LAMBDA_FUNCTION_NAME: efrouting-fetcher
  AWS_REGION: us-east-1

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    outputs:
      artifact-path: ${{ steps.artifact.outputs.path }}

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      working-directory: compute/lambda
      run: |
        python -m pip install --upgrade pip
        mkdir -p package
        pip install -r requirements.txt -t package/

    - name: Copy Lambda code
      working-directory: compute/lambda
      run: |
        cp app.py package/
        cp model.py package/

    - name: Create deployment package
      working-directory: compute/lambda
      run: |
        cd package
        zip -r ../lambda-deployment.zip .
        cd ..

    - name: Upload artifact
      id: artifact
      run: |
        echo "path=compute/lambda/lambda-deployment.zip" >> $GITHUB_OUTPUT

    - name: Upload to GitHub Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lambda-deployment
        path: compute/lambda/lambda-deployment.zip
        retention-days: 5

  test:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r compute/lambda/requirements.txt
        pip install pytest python-dateutil

    - name: Run tests
      working-directory: compute/lambda/tests
      run: pytest test_app.py -v

  deploy:
    needs: [build, test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      id-token: write

    steps:
    - uses: actions/checkout@v6

    - name: Download artifact
      uses: actions/download-artifact@v6
      with:
        name: lambda-deployment

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Get current Lambda function info
      run: |
        aws lambda get-function \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
          --region ${{ env.AWS_REGION }} \
          || echo "Function does not exist yet"

    - name: Deploy Lambda function
      run: |
        aws lambda update-function-code \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
          --zip-file fileb://lambda-deployment.zip \
          --region ${{ env.AWS_REGION }} \
          || aws lambda create-function \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --runtime python3.11 \
            --role ${{ secrets.LAMBDA_EXECUTION_ROLE_ARN }} \
            --handler app.lambda_handler \
            --zip-file fileb://lambda-deployment.zip \
            --region ${{ env.AWS_REGION }}

    - name: Wait for update
      run: sleep 5

    - name: Get Lambda function version
      id: lambda-version
      run: |
        VERSION=$(aws lambda get-function \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
          --region ${{ env.AWS_REGION }} \
          --query 'Configuration.FunctionArn' \
          --output text)
        echo "arn=${VERSION}" >> $GITHUB_OUTPUT

    - name: Publish Lambda function version
      run: |
        aws lambda publish-version \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
          --region ${{ env.AWS_REGION }}

    - name: Create deployment comment
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ… Lambda Function Deployed\n\nFunction: `${{ env.LAMBDA_FUNCTION_NAME }}`\nVersion: `${{ steps.lambda-version.outputs.arn }}`'
          });
